# ParserHub V3 Hub 서버 기능 명세

## 개요
ParserHub V3 Hub는 쿠팡 전용 실시간 제품 순위 조회 서비스의 중앙 관리 서버입니다.

## 주요 기능

### 1. 에이전트 관리 시스템

#### 1.1 실시간 연결 관리
- **Socket.IO 기반 통신**: 에이전트와 양방향 실시간 통신
- **자동 등록/해제**: 연결 시 자동 등록, 연결 해제 시 자동 정리
- **작업 재배정**: 에이전트 연결 해제 시 진행 중인 작업 자동 재배정

#### 1.2 하트비트 모니터링
- **주기**: 30초마다 하트비트 확인
- **타임아웃**: 60초 동안 응답 없으면 error 상태로 변경
- **자동 복구**: 하트비트 재개 시 자동으로 정상 상태 복구

#### 1.3 단순 롤링 전략
- **순차 선택**: 가장 오래 사용하지 않은 에이전트 우선 선택
- **쿨다운 없음**: 차단되어도 즉시 다음 에이전트로 전환
- **공평한 분배**: 모든 에이전트를 순환하며 균등 사용
- **차단 기록**: 통계용으로만 차단 이벤트 기록

### 2. API 서비스

#### 2.1 쿠팡 검색 API
```
GET /api/v3/coupang
```
- **파라미터**:
  - `keyword`: 검색 키워드 (필수)
  - `code`: 제품 코드 (필수)
  - `pages`: 검색 페이지 수 (선택, 기본값: 1)
  - `key`: API 키 (필수)
  - `browser`: 브라우저 지정 (선택: chrome/firefox/firefox-nightly/edge/auto)

- **응답**: 제품 순위, 상세 정보, 실행 시간 등

#### 2.2 에이전트 상태 API
```
GET /api/v3/agents/status          # 기본 상태 (총 개수, 브라우저별 통계)
GET /api/v3/agents/rolling-status  # 롤링 상태 (사용 순서, 차단 기록)
GET /api/v3/agents/health          # 헬스 체크 (하트비트 상태)
```

#### 2.3 서버 상태 API
```
GET /health  # 서버 헬스 체크
```

### 3. 과금 시스템

#### 3.1 과금 정책
- **단위**: keyword + code 조합
- **요금**: 일일 30원 (중복 제거)
- **집계**: 일별 집계, 월말 정산

#### 3.2 과금 처리
- 동일한 keyword + code + 날짜 조합은 하루 1회만 과금
- 요청 횟수와 성공/실패 통계 별도 기록
- 실시간 과금 처리 및 DB 저장

### 4. 데이터베이스 관리

#### 4.1 테이블 구조
- **v3_api_keys**: API 키 관리 및 인증
- **v3_coupang_billing_usage**: 과금 사용량 기록
- **v3_coupang_ranking_history**: 순위 조회 이력 저장

#### 4.2 데이터 보존
- 과금 데이터: 영구 보존
- 조회 이력: 분석용 장기 보존
- 에이전트 로그: 7일 후 자동 삭제

### 5. 보안 및 인증

#### 5.1 API 키 인증
- 모든 API 요청에 유효한 API 키 필요
- 키별 사용량 추적 및 제한 가능

#### 5.2 접근 제어
- API 키별 권한 관리
- IP 기반 접근 제어 (옵션)

### 6. 모니터링 및 로깅

#### 6.1 로깅 시스템
- Winston 기반 구조화된 로깅
- 로그 레벨: error, warn, info, debug
- 일별 로그 파일 자동 로테이션

#### 6.2 실시간 모니터링
- 에이전트 상태 실시간 확인
- 작업 큐 및 처리 현황
- 시스템 리소스 사용량

## 시스템 아키텍처

```
Hub Server (u24.techb.kr)
├── Express.js API Server
├── Socket.IO Server (같은 포트)
├── Agent Manager (에이전트 풀 관리)
├── Rolling Manager (순차 선택 로직)
├── Heartbeat Manager (상태 모니터링)
└── PostgreSQL Connection
```

## 확장성

### 수평 확장
- 에이전트 추가: 새 VM에 에이전트 설치만으로 자동 확장
- 최대 지원: 이론상 무제한 (실제 테스트: 30개 에이전트)

### 부하 분산
- 에이전트 간 자동 부하 분산
- 브라우저 타입별 분산 가능

## 운영 고려사항

1. **장애 복구**: 에이전트 자동 재연결, 작업 자동 재배정
2. **성능**: 동시 처리 가능 작업 수 = 연결된 에이전트 수
3. **가용성**: 24/7 운영 가능, PM2를 통한 자동 재시작